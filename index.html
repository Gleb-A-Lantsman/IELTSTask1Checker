<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Task 1 - Visual Description Tool</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      h2, h3 {
        color: #333;
      }

      .task-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .category-selector {
        margin-bottom: 15px;
      }

      .category-selector label {
        font-weight: bold;
        margin-right: 10px;
      }

      select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        margin-right: 10px;
      }

      .image-selector {
        margin-bottom: 15px;
      }

      button {
        padding: 10px 20px;
        background-color: #0066cc;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
      }

      button:hover {
        background-color: #0052a3;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      #load-image-btn {
        background-color: #6c757d;
      }

      #random-image-btn {
        background-color: #17a2b8;
      }

      .task-image-container {
        margin-top: 15px;
        text-align: center;
        background-color: #fafafa;
        padding: 15px;
        border-radius: 4px;
        border: 2px dashed #ddd;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .task-image-container img {
        max-width: 100%;
        max-height: 500px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      .placeholder-text {
        color: #999;
        font-style: italic;
      }

      .writing-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      textarea {
        width: 100%;
        min-height: 200px;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        box-sizing: border-box;
      }

      .button-container {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      #help-button {
        background-color: #28a745;
      }

      #help-button:hover {
        background-color: #218838;
      }

      .word-count {
        text-align: right;
        color: #666;
        font-size: 14px;
        margin-top: 10px;
      }

      .feedback-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }

      .feedback-container h4 {
        margin-top: 0;
        color: #333;
      }

      .comparison-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .comparison-side {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .comparison-side h5 {
        margin-top: 0;
        color: #333;
        text-align: center;
      }

      .comparison-side img {
        max-width: 100%;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      .loading-image {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .criteria-section {
        margin-top: 15px;
        padding: 12px;
        border-radius: 4px;
        background-color: #f8f9fa;
      }

      .criteria-section h5 {
        margin-top: 0;
        margin-bottom: 8px;
        color: #495057;
      }

      .task-achievement {
        border-left: 4px solid #007bff;
      }

      .coherence-cohesion {
        border-left: 4px solid #28a745;
      }

      .lexical-resource {
        border-left: 4px solid #ffc107;
      }

      .grammatical-range {
        border-left: 4px solid #dc3545;
      }

      .help-feedback {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 10px;
      }

      .missing-content {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
      }

      .structure-issue {
        background-color: #fff8e1;
        border-left: 4px solid #ffc107;
      }

      .word-choice {
        background-color: #f3e5f5;
        border-left: 4px solid #9c27b0;
      }

      .grammar-check {
        background-color: #ffebee;
        border-left: 4px solid #f44336;
      }

      .good-progress {
        background-color: #e8f5e9;
        border-left: 4px solid #4caf50;
      }

      .data-accuracy {
        background-color: #e1f5fe;
        border-left: 4px solid #0288d1;
      }

      @media (max-width: 768px) {
        .comparison-container {
          grid-template-columns: 1fr;
        }
      }

      .error-message {
        color: #dc3545;
        padding: 10px;
        background-color: #f8d7da;
        border-radius: 4px;
        margin-top: 10px;
      }

      .instructions {
        background-color: #e7f3ff;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #0066cc;
      }

      .instructions h4 {
        margin-top: 0;
        color: #0066cc;
      }

      .instructions ul {
        margin: 10px 0;
        padding-left: 20px;
      }

      .instructions li {
        margin: 5px 0;
      }

      .vision-status {
        margin-top: 10px;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
        display: inline-block;
      }

      .vision-cached {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .vision-loading {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .vision-downloaded {
        background-color: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
      }

      .progress-container {
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        display: none;
      }

      .progress-container.active {
        display: block;
      }

      .progress-label {
        font-size: 14px;
        color: #495057;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .progress-bar-bg {
        width: 100%;
        height: 24px;
        background-color: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #0066cc, #4a90e2);
        border-radius: 12px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .progress-time {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
        text-align: right;
      }

      .poll-status {
        margin-top: 10px;
        padding: 8px 12px;
        background-color: #fff3cd;
        border-radius: 4px;
        font-size: 13px;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
    </style>
  </head>
  <body>
    <h1>IELTS Writing Task 1 - Visual Description Practice</h1>

    <div class="instructions">
      <h4>üìù Instructions</h4>
      <ul>
        <li><strong>Select a task type</strong> and load an image to practice describing</li>
        <li><strong>Write at least 150 words</strong> describing the visual information</li>
        <li>Click <strong>"Help me!"</strong> for quick tips while writing</li>
        <li>Click <strong>"Get Feedback"</strong> to see how well your description matches the image</li>
        <li>For maps, the AI will generate a visualization (PNG first with 2-minute timeout, ASCII emoji fallback if needed)</li>
      </ul>
    </div>

    <div class="task-container">
      <h2>Task Image</h2>
      
      <div class="category-selector">
        <label for="category-select">Select Task Type:</label>
        <select id="category-select">
          <option value="">-- Choose a category --</option>
          <option value="table">Table</option>
          <option value="line-graph">Line/Polyline Graph</option>
          <option value="bar-chart">Bar Chart</option>
          <option value="pie-chart">Pie Chart</option>
          <option value="flowchart">Flowchart/Process Diagram</option>
          <option value="maps">Pictures/Maps</option>
        </select>
        <button id="random-image-btn">Random Image</button>
      </div>

      <div class="image-selector" id="image-selector-container" style="display: none;">
        <label for="image-select">Choose specific image:</label>
        <select id="image-select">
          <option value="">-- Loading images... --</option>
        </select>
        <button id="load-image-btn">Load Image</button>
      </div>

      <div class="task-image-container" id="task-image-container">
        <p class="placeholder-text">Select a category and load an image to begin</p>
      </div>

      <div id="vision-status-container"></div>

      <div id="image-instructions" style="margin-top: 15px; padding: 10px; background-color: #fffbea; border-radius: 4px; display: none;">
        <strong>Task:</strong> Summarize the information by selecting and reporting the main features, and make comparisons where relevant. Write at least 150 words.
      </div>
    </div>

    <div class="writing-container">
      <h3>Your Answer</h3>
      <textarea
        id="essay-input"
        placeholder="Write your description here. Remember to:
- Write an overview statement
- Describe key features and trends
- Include specific data/numbers
- Make comparisons where relevant
- Write at least 150 words"
      ></textarea>

      <div class="button-container">
        <button id="help-button">Help me!</button>
        <button id="feedback-button">Get Feedback</button>
      </div>

      <div class="word-count">
        <span id="word-count">0 words</span>
        <span id="word-goal" style="margin-left: 10px; color: #ff9800;"></span>
      </div>
    </div>

    <div id="progress-container" class="progress-container">
      <div class="progress-label" id="progress-label">Processing...</div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%">
          <span id="progress-percent">0%</span>
        </div>
      </div>
      <div class="progress-time" id="progress-time"></div>
      <div id="poll-status" class="poll-status" style="display: none;"></div>
    </div>

    <div id="feedback-container" class="feedback-container">
      <h4>Writing Feedback</h4>
      <p>
        Write your description and click <strong>"Help me!"</strong> for quick suggestions, 
        or <strong>"Get Feedback"</strong> for comprehensive analysis with visual comparison.
      </p>
    </div>

    <div id="comparison-container" style="display: none;"></div>

    <script type="module">
      document.addEventListener("DOMContentLoaded", () => {
        const categorySelect = document.getElementById('category-select');
        const imageSelect = document.getElementById('image-select');
        const imageSelectorContainer = document.getElementById('image-selector-container');
        const loadImageBtn = document.getElementById('load-image-btn');
        const randomImageBtn = document.getElementById('random-image-btn');
        const taskImageContainer = document.getElementById('task-image-container');
        const visionStatusContainer = document.getElementById('vision-status-container');
        const imageInstructions = document.getElementById('image-instructions');
        const essayTextarea = document.getElementById('essay-input');
        const feedbackContainer = document.getElementById('feedback-container');
        const comparisonContainer = document.getElementById('comparison-container');
        const wordCountDisplay = document.getElementById('word-count');
        const wordGoalDisplay = document.getElementById('word-goal');
        const helpButton = document.getElementById('help-button');
        const feedbackButton = document.getElementById('feedback-button');

        const progressContainer = document.getElementById('progress-container');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const progressPercent = document.getElementById('progress-percent');
        const progressLabel = document.getElementById('progress-label');
        const progressTime = document.getElementById('progress-time');
        const pollStatus = document.getElementById('poll-status');

        let currentImageUrl = '';
        let currentImageName = '';
        let currentCategory = '';
        let availableImages = {};
        let isLoading = false;
        let pollInterval = null;
        let pollAttempts = 0;

        const API_BASE = 'https://ubiquitous-malasada.netlify.app/.netlify/functions';

        function showProgressBar(taskType) {
          progressContainer.classList.add('active');
          comparisonContainer.style.display = 'none';
          pollStatus.style.display = 'none';
          
          let label = taskType === 'maps' 
            ? 'Preparing map generation...' 
            : taskType === 'table'
            ? 'Generating ASCII table...'
            : 'Generating chart...';
          
          progressLabel.textContent = label;
          progressBarFill.style.width = '10%';
          progressPercent.textContent = '10%';
          progressTime.textContent = '';
        }
        
        function updateProgress(percent, label) {
          progressBarFill.style.width = percent + '%';
          progressPercent.textContent = Math.floor(percent) + '%';
          if (label) {
            progressLabel.textContent = label;
          }
        }
        
        function hideProgressBar() {
          progressBarFill.style.width = '100%';
          progressPercent.textContent = '100%';
          progressLabel.textContent = 'Complete!';
          
          setTimeout(() => {
            progressContainer.classList.remove('active');
            progressBarFill.style.width = '0%';
            progressPercent.textContent = '0%';
            pollStatus.style.display = 'none';
          }, 1000);
        }

        categorySelect.addEventListener('change', async () => {
          const category = categorySelect.value;
          if (!category) {
            imageSelectorContainer.style.display = 'none';
            return;
          }

          currentCategory = category;
          imageSelect.innerHTML = '<option value="">-- Loading images from GitHub... --</option>';
          imageSelectorContainer.style.display = 'block';

          try {
            const owner = "Gleb-A-Lantsman";
            const repo = "IELTSTask1Checker";
            const visualsPath = `visuals/${category}`;
            const githubApiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${visualsPath}`;

            const response = await fetch(githubApiUrl);
            if (!response.ok) throw new Error(`GitHub fetch failed: ${response.status}`);
            const files = await response.json();

            const imageFiles = files.filter(f => /\.(png|jpg|jpeg|webp)$/i.test(f.name));

            if (imageFiles.length === 0) {
              imageSelect.innerHTML = '<option value="">-- No images found in this category --</option>';
              return;
            }

            availableImages[category] = imageFiles;
            imageSelect.innerHTML = '<option value="">-- Choose an image --</option>';

            imageFiles.forEach((img, index) => {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = img.name;
              imageSelect.appendChild(option);
            });

            imageSelectorContainer.style.display = 'block';
          } catch (error) {
            console.error('Error fetching from GitHub:', error);
            imageSelect.innerHTML = '<option value="">-- Error loading images --</option>';
            showError('‚ö†Ô∏è Failed to fetch images from GitHub repository.');
          }
        });

        loadImageBtn.addEventListener('click', () => {
          const imageIndex = imageSelect.value;
          if (imageIndex === '' || !availableImages[currentCategory]) {
            return;
          }

          const image = availableImages[currentCategory][imageIndex];
          loadImage(image.download_url, image.name);
        });

        randomImageBtn.addEventListener('click', () => {
          const category = categorySelect.value;
          if (!category) {
            alert('Please select a category first');
            return;
          }

          const images = availableImages[category];
          if (!images || images.length === 0) {
            alert('No images loaded for this category yet.');
            return;
          }

          const randomIndex = Math.floor(Math.random() * images.length);
          const image = images[randomIndex];
          imageSelect.value = randomIndex;
          loadImage(image.download_url, image.name);
        });

        function loadImage(url, fileName) {
          currentImageUrl = url;
          currentImageName = fileName;
          
          taskImageContainer.innerHTML = `<img src="${url}" alt="Task 1 visual">`;
          imageInstructions.style.display = 'block';
          comparisonContainer.style.display = 'none';
          comparisonContainer.innerHTML = '';
          
          visionStatusContainer.innerHTML = '<span class="vision-status vision-cached">‚úÖ Image loaded - ready for feedback</span>';
        }

        function showError(message) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          errorDiv.textContent = message;
          feedbackContainer.appendChild(errorDiv);
          setTimeout(() => errorDiv.remove(), 10000);
        }

        function updateWordCount() {
          const text = essayTextarea.value.trim();
          const count = text ? text.split(/\s+/).length : 0;
          wordCountDisplay.textContent = `${count} words`;
          
          if (count < 150) {
            wordGoalDisplay.textContent = `Need ${150 - count} more words to reach minimum`;
            wordGoalDisplay.style.color = '#ff9800';
          } else {
            wordGoalDisplay.textContent = '‚úì Word count requirement met';
            wordGoalDisplay.style.color = '#4caf50';
          }
        }

        essayTextarea.addEventListener('input', updateWordCount);

        helpButton.addEventListener('click', () => {
          if (essayTextarea.value.length > 10) {
            requestFeedback('help');
          } else {
            feedbackContainer.innerHTML = '<h4>Writing Help</h4><p>Please write something first.</p>';
          }
        });

        feedbackButton.addEventListener('click', () => {
          if (!currentImageUrl) {
            feedbackContainer.innerHTML = '<h4>Writing Feedback</h4><p>Please load a task image first.</p>';
            return;
          }
          
          if (essayTextarea.value.length > 10) {
            requestFeedback('full-feedback');
          } else {
            feedbackContainer.innerHTML = '<h4>Writing Feedback</h4><p>Please write something first.</p>';
          }
        });

        async function requestFeedback(type) {
          if (isLoading) {
            console.log('Already loading...');
            return;
          }
          
          isLoading = true;
          feedbackButton.disabled = true;
          helpButton.disabled = true;

          const content = essayTextarea.value;

          try {
            // MAPS: Async PNG (2x timeout) with ASCII fallback
            if (currentCategory === "maps" && type === "full-feedback") {
              showProgressBar('maps');
              updateProgress(10, 'Submitting PNG generation job...');

              const submitResponse = await fetch(`${API_BASE}/openai-proxy-task1`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  phase: "submit",
                  requestType: "full-feedback",
                  taskType: "maps",
                  content
                })
              });

              if (!submitResponse.ok) {
                throw new Error(`Submit failed: ${submitResponse.status}`);
              }

              const submitData = await submitResponse.json();
              
              if (submitData.error || !submitData.job_id) {
                throw new Error(submitData.message || 'Failed to submit PNG job');
              }

              const job_id = submitData.job_id;
              console.log("‚úÖ PNG job submitted:", job_id);

              updateProgress(20, 'PNG generation in progress...');
              pollStatus.style.display = 'block';
              pollStatus.textContent = 'Generating PNG map...';

              pollAttempts = 0;
              const MAX_PNG_ATTEMPTS = 60; // 120 seconds (2x original)
              
              const pollForPngResults = async () => {
                pollAttempts++;
                
                if (pollAttempts > MAX_PNG_ATTEMPTS) {
                  console.warn("‚ö†Ô∏è PNG taking too long, falling back to ASCII...");
                  clearInterval(pollInterval);
                  pollInterval = null;
                  
                  updateProgress(25, 'PNG timeout - switching to ASCII...');
                  startAsciiFallback();
                  return;
                }

                const progress = Math.min(20 + (pollAttempts / MAX_PNG_ATTEMPTS) * 60, 80);
                updateProgress(progress, 'Generating PNG map...');
                pollStatus.textContent = `Checking PNG status (${pollAttempts}/${MAX_PNG_ATTEMPTS})...`;

                try {
                  const pollResponse = await fetch(`${API_BASE}/openai-proxy-task1`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      phase: "poll",
                      job_id
                    })
                  });

                  if (!pollResponse.ok) {
                    throw new Error(`Poll failed: ${pollResponse.status}`);
                  }

                  const pollData = await pollResponse.json();
                  console.log(`‚è≥ PNG Poll ${pollAttempts}:`, pollData.status);

                  if (pollData.status === "error") {
                    console.warn("PNG generation failed:", pollData.error);
                    clearInterval(pollInterval);
                    pollInterval = null;
                    
                    updateProgress(25, 'PNG failed - switching to ASCII...');
                    startAsciiFallback();
                    return;
                  }

                  if (pollData.status === "completed" && pollData.generatedImageBase64) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    
                    console.log("‚úÖ PNG received");
                    updateProgress(95, 'Finalizing...');
                    
                    feedbackContainer.innerHTML = formatFullFeedback(
                      pollData.feedback || "**Task Achievement**: Map generated successfully."
                    );

                    comparisonContainer.style.display = "block";
                    comparisonContainer.innerHTML = `
                      <div class="comparison-container">
                        <div class="comparison-side">
                          <h5>üó∫Ô∏è Original Task Image</h5>
                          <img src="${currentImageUrl}" alt="Original map">
                        </div>
                        <div class="comparison-side">
                          <h5>üñºÔ∏è PNG Generated from Your Description</h5>
                          <img src="${pollData.generatedImageBase64}" alt="Generated map" style="max-width:100%;border-radius:4px;">
                          <p style="margin-top: 10px; font-size: 13px; color: #666; text-align: center;">
                            Generated using DALL-E 3. AI can make mistakes, check carefully.
                          </p>
                        </div>
                      </div>
                    `;

                    hideProgressBar();
                    isLoading = false;
                    feedbackButton.disabled = false;
                    helpButton.disabled = false;
                  }
                } catch (pollError) {
                  console.error('PNG poll error:', pollError);
                  clearInterval(pollInterval);
                  pollInterval = null;
                  
                  updateProgress(25, 'Error - switching to ASCII...');
                  startAsciiFallback();
                }
              };

              const startAsciiFallback = async () => {
                try {
                  console.log("üó∫Ô∏è Starting ASCII emoji fallback...");
                  pollStatus.textContent = 'Submitting ASCII job...';
                  
                  const asciiSubmitResponse = await fetch(`${API_BASE}/openai-proxy-task1`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      phase: "submit-ascii",
                      requestType: "full-feedback",
                      taskType: "maps",
                      content
                    })
                  });

                  if (!asciiSubmitResponse.ok) {
                    throw new Error(`ASCII submit failed: ${asciiSubmitResponse.status}`);
                  }

                  const asciiSubmitData = await asciiSubmitResponse.json();
                  
                  if (asciiSubmitData.error || !asciiSubmitData.job_id) {
                    throw new Error(asciiSubmitData.message || 'Failed to submit ASCII job');
                  }

                  const ascii_job_id = asciiSubmitData.job_id;
                  console.log("‚úÖ ASCII job submitted:", ascii_job_id);

                  updateProgress(30, 'ASCII generation in progress...');
                  pollStatus.textContent = 'Generating ASCII emoji maps...';

                  pollAttempts = 0;
                  const MAX_ASCII_ATTEMPTS = 30; // 60 seconds for ASCII
                  
                  const pollForAsciiResults = async () => {
                    pollAttempts++;
                    
                    if (pollAttempts > MAX_ASCII_ATTEMPTS) {
                      clearInterval(pollInterval);
                      pollInterval = null;
                      hideProgressBar();
                      isLoading = false;
                      feedbackButton.disabled = false;
                      helpButton.disabled = false;
                      
                      feedbackContainer.innerHTML = `
                        <h4>Complete Feedback</h4>
                        <p class="error-message">‚ö†Ô∏è Timeout: ASCII generation took too long. Please try again.</p>
                      `;
                      return;
                    }

                    const progress = Math.min(30 + (pollAttempts / MAX_ASCII_ATTEMPTS) * 60, 90);
                    updateProgress(progress, 'Generating ASCII emoji maps...');
                    pollStatus.textContent = `ASCII status check ${pollAttempts}/${MAX_ASCII_ATTEMPTS}...`;

                    try {
                      const asciiPollResponse = await fetch(`${API_BASE}/openai-proxy-task1`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                          phase: "poll",
                          job_id: ascii_job_id
                        })
                      });

                      if (!asciiPollResponse.ok) {
                        throw new Error(`ASCII poll failed: ${asciiPollResponse.status}`);
                      }

                      const asciiPollData = await asciiPollResponse.json();
                      console.log(`‚è≥ ASCII Poll ${pollAttempts}:`, asciiPollData.status);

                      if (asciiPollData.status === "error") {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        throw new Error(asciiPollData.error || 'ASCII job failed');
                      }

                      if (asciiPollData.status === "completed" && asciiPollData.asciiMaps) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        
                        console.log("‚úÖ ASCII maps received");
                        updateProgress(95, 'Finalizing...');
                        
                        feedbackContainer.innerHTML = formatFullFeedback(
                          asciiPollData.feedback || "**Task Achievement**: ASCII maps generated (fallback)."
                        );

                        comparisonContainer.style.display = "block";
                        comparisonContainer.innerHTML = `
                          <div class="comparison-container">
                            <div class="comparison-side">
                            <h5>üó∫Ô∏è Original Task Image</h5>
                              <img src="${currentImageUrl}" alt="Original map">
                                  </div>
                                  <div class="comparison-side">
                                    <h5>üó∫Ô∏è ASCII Emoji Maps from Your Description</h5>
                                      <pre style="
                                        background: #1e1e1e;
                                        color: #ffffff;
                                        padding: 20px;
                                          border-radius: 8px;
                                        font-family: 'Courier New', 'Consolas', monospace;
                                        font-size: 20px;
                                        line-height: 1.2;
                                        letter-spacing: 0;
                                          overflow-x: auto;
                                          white-space: pre;
                                          display: inline-block;
                                          ">${asciiPollData.asciiMaps}</pre>
                                            <p style="margin-top: 10px; font-size: 13px; color: #666; text-align: center;">
                                              Generated using ASCII emojis (fallback). AI can make mistakes, check carefully.
                                              </p>
                                            </div>
                                              </div>
                                              `;

                        hideProgressBar();
                        isLoading = false;
                        feedbackButton.disabled = false;
                        helpButton.disabled = false;
                      }
                    } catch (asciiPollError) {
                      console.error('ASCII poll error:', asciiPollError);
                      clearInterval(pollInterval);
                      pollInterval = null;
                      hideProgressBar();
                      isLoading = false;
                      feedbackButton.disabled = false;
                      helpButton.disabled = false;
                      
                      feedbackContainer.innerHTML = `
                        <h4>Complete Feedback</h4>
                        <p class="error-message">‚ö†Ô∏è Error: ${asciiPollError.message}</p>
                      `;
                    }
                  };

                  if (pollInterval) clearInterval(pollInterval);
                  pollInterval = setInterval(pollForAsciiResults, 2000);
                  pollForAsciiResults();
                  
                } catch (asciiError) {
                  console.error('ASCII fallback error:', asciiError);
                  hideProgressBar();
                  isLoading = false;
                  feedbackButton.disabled = false;
                  helpButton.disabled = false;
                  
                  feedbackContainer.innerHTML = `
                    <h4>Complete Feedback</h4>
                    <p class="error-message">‚ö†Ô∏è Both PNG and ASCII generation failed. Please try again.</p>
                  `;
                }
              };

              if (pollInterval) clearInterval(pollInterval);
              pollInterval = setInterval(pollForPngResults, 2000);
              pollForPngResults();
              
              return;
            }

            // NON-MAPS feedback
            if (type === 'help') {
              showProgressBar('help');
              updateProgress(50, 'Getting feedback...');
              
              const res = await fetch(`${API_BASE}/openai-proxy-task1`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  content,
                  requestType: type,
                  taskType: currentCategory
                })
              });

              if (!res.ok) {
                throw new Error(`Request failed: ${res.status}`);
              }

              const data = await res.json();
              
              if (data.error) {
                throw new Error(data.message || 'Feedback generation failed');
              }

              feedbackContainer.innerHTML = formatHelpFeedback(data.feedback);
              hideProgressBar();
              
            } else if (type === 'full-feedback') {
              showProgressBar(currentCategory);
              updateProgress(30, 'Generating visualization...');

              const res = await fetch(`${API_BASE}/openai-proxy-task1`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  content,
                  requestType: type,
                  taskType: currentCategory,
                  imageUrl: currentImageUrl,
                  imageName: currentImageName
                })
              });

              if (!res.ok) {
                throw new Error(`Request failed: ${res.status}`);
              }

              const data = await res.json();

              if (data.error) {
                throw new Error(data.message || 'Feedback generation failed');
              }

              updateProgress(90, 'Finalizing...');
              displayFullFeedback(data);
              hideProgressBar();
            }

          } catch (err) {
            console.error('Request error:', err);
            hideProgressBar();
            feedbackContainer.innerHTML = `
              <h4>Complete Feedback</h4>
              <p class="error-message">‚ö†Ô∏è ${err.message}</p>
            `;
          } finally {
            isLoading = false;
            feedbackButton.disabled = false;
            helpButton.disabled = false;
          }
        }

        function displayFullFeedback(data) {
          feedbackContainer.innerHTML = formatFullFeedback(data.feedback);

          comparisonContainer.innerHTML = "";
          comparisonContainer.style.display = "block";

          if (data.asciiTable) {
            comparisonContainer.innerHTML = `
              <div class="comparison-container">
                <div class="comparison-side">
                  <h5>üìä Original Task Image</h5>
                  <img src="${currentImageUrl}" alt="Original task image">
                </div>
                <div class="comparison-side">
                  <h5>üßÆ ASCII Table from Your Description</h5>
                  <pre style="background:#fafafa; padding:15px; border-radius:4px; border:1px solid #ddd; font-family:monospace; overflow-x:auto;">${data.asciiTable}</pre>
                  <p style="margin-top: 10px; font-size: 13px; color: #666; text-align: center;">
                    Generated based on your description. AI can make mistakes, check carefully.
                  </p>
                </div>
              </div>
            `;
          } else if (data.generatedImageBase64) {
            comparisonContainer.innerHTML = `
              <div class="comparison-container">
                <div class="comparison-side">
                  <h5>üìä Original Task Image</h5>
                  <img src="${currentImageUrl}" alt="Original task image">
                </div>
                <div class="comparison-side">
                  <h5>üêç Python Chart from Your Description</h5>
                  <img src="${data.generatedImageBase64}" alt="Generated chart" style="max-width: 100%; border-radius: 4px;">
                  <p style="margin-top: 10px; font-size: 13px; color: #666; text-align: center;">
                    Generated using Python (Matplotlib). AI can make mistakes, check carefully.
                  </p>
                </div>
              </div>
            `;
          }
        }

        function formatFullFeedback(fb) {
          const text = fb.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          let html = '<h4>Complete Feedback</h4>';

          const sections = {
            'Task Achievement': 'task-achievement',
            'Coherence and Cohesion': 'coherence-cohesion',
            'Lexical Resource': 'lexical-resource',
            'Grammatical Range and Accuracy': 'grammatical-range'
          };

          let foundSections = false;
          Object.keys(sections).forEach(sectionName => {
            const regex = new RegExp(`<strong>${sectionName}:?</strong>([\\s\\S]*?)(?=<strong>|$)`, 'i');
            const match = text.match(regex);
            
            if (match) {
              foundSections = true;
              const content = match[1].trim();
              html += `
                <div class="criteria-section ${sections[sectionName]}">
                  <h5>${sectionName}</h5>
                  <p>${content}</p>
                </div>
              `;
            }
          });

          if (!foundSections) {
            html += `<p>${text}</p>`;
          }

          return html;
        }

        function formatHelpFeedback(fb) {
          const clean = fb.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').trim();
          
          const classes = {
            'Missing content:': 'missing-content',
            'Structure issue:': 'structure-issue',
            'Word choice:': 'word-choice',
            'Grammar check:': 'grammar-check',
            'Good progress!': 'good-progress',
            'Data accuracy:': 'data-accuracy'
          };

          let html = '<h4>Writing Help</h4>';
          let matched = false;

          Object.keys(classes).forEach(label => {
            const tag = `<strong>${label}</strong>`;
            if (!matched && clean.includes(tag)) {
              const content = clean.split(tag)[1].trim();
              html += `<div class="help-feedback ${classes[label]}"><strong>${label}</strong> ${content}</div>`;
              matched = true;
            }
          });

          if (!matched) {
            html += `<p>${clean}</p>`;
          }

          return html;
        }

        updateWordCount();
      });
    </script>
  </body>
</html>

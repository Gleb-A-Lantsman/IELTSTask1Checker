<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Task 1 - Visual Description Tool</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      h2, h3 {
        color: #333;
      }

      .task-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .category-selector {
        margin-bottom: 15px;
      }

      .category-selector label {
        font-weight: bold;
        margin-right: 10px;
      }

      select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        margin-right: 10px;
      }

      .image-selector {
        margin-bottom: 15px;
      }

      button {
        padding: 10px 20px;
        background-color: #0066cc;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
      }

      button:hover {
        background-color: #0052a3;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      #load-image-btn {
        background-color: #6c757d;
      }

      #random-image-btn {
        background-color: #17a2b8;
      }

      .task-image-container {
        margin-top: 15px;
        text-align: center;
        background-color: #fafafa;
        padding: 15px;
        border-radius: 4px;
        border: 2px dashed #ddd;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .task-image-container img {
        max-width: 100%;
        max-height: 500px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      .placeholder-text {
        color: #999;
        font-style: italic;
      }

      .writing-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      textarea {
        width: 100%;
        min-height: 200px;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        box-sizing: border-box;
      }

      .button-container {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      #help-button {
        background-color: #28a745;
      }

      #help-button:hover {
        background-color: #218838;
      }

      .word-count {
        text-align: right;
        color: #666;
        font-size: 14px;
        margin-top: 10px;
      }

      .feedback-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }

      .feedback-container h4 {
        margin-top: 0;
        color: #333;
      }

      /* Comparison view */
      .comparison-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .comparison-side {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .comparison-side h5 {
        margin-top: 0;
        color: #333;
        text-align: center;
      }

      .comparison-side img {
        max-width: 100%;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      .loading-image {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      /* Feedback sections */
      .criteria-section {
        margin-top: 15px;
        padding: 12px;
        border-radius: 4px;
        background-color: #f8f9fa;
      }

      .criteria-section h5 {
        margin-top: 0;
        margin-bottom: 8px;
        color: #495057;
      }

      .task-achievement {
        border-left: 4px solid #007bff;
      }

      .coherence-cohesion {
        border-left: 4px solid #28a745;
      }

      .lexical-resource {
        border-left: 4px solid #ffc107;
      }

      .grammatical-range {
        border-left: 4px solid #dc3545;
      }

      /* Help feedback */
      .help-feedback {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 10px;
      }

      .missing-content {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
      }

      .structure-issue {
        background-color: #fff8e1;
        border-left: 4px solid #ffc107;
      }

      .word-choice {
        background-color: #f3e5f5;
        border-left: 4px solid #9c27b0;
      }

      .grammar-check {
        background-color: #ffebee;
        border-left: 4px solid #f44336;
      }

      .good-progress {
        background-color: #e8f5e9;
        border-left: 4px solid #4caf50;
      }

      .data-accuracy {
        background-color: #e1f5fe;
        border-left: 4px solid #0288d1;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .comparison-container {
          grid-template-columns: 1fr;
        }
      }

      .error-message {
        color: #dc3545;
        padding: 10px;
        background-color: #f8d7da;
        border-radius: 4px;
        margin-top: 10px;
      }

      .instructions {
        background-color: #e7f3ff;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #0066cc;
      }

      .instructions h4 {
        margin-top: 0;
        color: #0066cc;
      }

      .instructions ul {
        margin: 10px 0;
        padding-left: 20px;
      }

      .instructions li {
        margin: 5px 0;
      }

      .vision-status {
        margin-top: 10px;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
        display: inline-block;
      }

      .vision-cached {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .vision-loading {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .vision-downloaded {
        background-color: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
      }

      /* Progress bar */
      .progress-container {
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        display: none;
      }

      .progress-container.active {
        display: block;
      }

      .progress-label {
        font-size: 14px;
        color: #495057;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .progress-bar-bg {
        width: 100%;
        height: 24px;
        background-color: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #0066cc, #4a90e2);
        border-radius: 12px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .progress-time {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <h1>IELTS Writing Task 1 - Visual Description Practice</h1>

    <div class="instructions">
      <h4>üìù Instructions</h4>
      <ul>
        <li><strong>Select a task type</strong> and load an image to practice describing</li>
        <li><strong>Write at least 150 words</strong> describing the visual information</li>
        <li>Click <strong>"Help me!"</strong> for quick tips while writing</li>
        <li>Click <strong>"Get Feedback"</strong> to see how well your description matches the image</li>
        <li>The AI will generate a visual based on your description to compare with the original</li>
      </ul>
    </div>

    <div class="task-container">
      <h2>Task Image</h2>
      
      <div class="category-selector">
        <label for="category-select">Select Task Type:</label>
        <select id="category-select">
          <option value="">-- Choose a category --</option>
          <option value="table">Table</option>
          <option value="line-graph">Line/Polyline Graph</option>
          <option value="bar-chart">Bar Chart</option>
          <option value="pie-chart">Pie Chart</option>
          <option value="flowchart">Flowchart/Process Diagram</option>
          <option value="maps">Pictures/Maps</option>
        </select>
        <button id="random-image-btn">Random Image</button>
      </div>

      <div class="image-selector" id="image-selector-container" style="display: none;">
        <label for="image-select">Choose specific image:</label>
        <select id="image-select">
          <option value="">-- Loading images... --</option>
        </select>
        <button id="load-image-btn">Load Image</button>
      </div>

      <div class="task-image-container" id="task-image-container">
        <p class="placeholder-text">Select a category and load an image to begin</p>
      </div>

      <div id="vision-status-container"></div>

      <div id="image-instructions" style="margin-top: 15px; padding: 10px; background-color: #fffbea; border-radius: 4px; display: none;">
        <strong>Task:</strong> Summarize the information by selecting and reporting the main features, and make comparisons where relevant. Write at least 150 words.
      </div>
    </div>

    <div class="writing-container">
      <h3>Your Answer</h3>
      <textarea
        id="essay-input"
        placeholder="Write your description here. Remember to:
‚Ä¢ Write an overview statement
‚Ä¢ Describe key features and trends
‚Ä¢ Include specific data/numbers
‚Ä¢ Make comparisons where relevant
‚Ä¢ Write at least 150 words"
      ></textarea>

      <div class="button-container">
        <button id="help-button">Help me!</button>
        <button id="feedback-button">Get Feedback</button>
      </div>

      <div class="word-count">
        <span id="word-count">0 words</span>
        <span id="word-goal" style="margin-left: 10px; color: #ff9800;"></span>
      </div>
    </div>

    <div id="progress-container" class="progress-container">
      <div class="progress-label" id="progress-label">Generating visualization...</div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%">
          <span id="progress-percent">0%</span>
        </div>
      </div>
      <div class="progress-time" id="progress-time">Estimated time: 0s</div>
    </div>

    <div id="feedback-container" class="feedback-container">
      <h4>Writing Feedback</h4>
      <p>
        Write your description and click <strong>"Help me!"</strong> for quick suggestions, 
        or <strong>"Get Feedback"</strong> for comprehensive analysis with visual comparison.
      </p>
    </div>

    <div id="comparison-container" style="display: none;"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const categorySelect = document.getElementById('category-select');
        const imageSelect = document.getElementById('image-select');
        const imageSelectorContainer = document.getElementById('image-selector-container');
        const loadImageBtn = document.getElementById('load-image-btn');
        const randomImageBtn = document.getElementById('random-image-btn');
        const taskImageContainer = document.getElementById('task-image-container');
        const visionStatusContainer = document.getElementById('vision-status-container');
        const imageInstructions = document.getElementById('image-instructions');
        const essayTextarea = document.getElementById('essay-input');
        const feedbackContainer = document.getElementById('feedback-container');
        const comparisonContainer = document.getElementById('comparison-container');
        const wordCountDisplay = document.getElementById('word-count');
        const wordGoalDisplay = document.getElementById('word-goal');
        const helpButton = document.getElementById('help-button');
        const feedbackButton = document.getElementById('feedback-button');

        // Progress bar elements
        const progressContainer = document.getElementById('progress-container');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const progressPercent = document.getElementById('progress-percent');
        const progressLabel = document.getElementById('progress-label');
        const progressTime = document.getElementById('progress-time');

        let currentImageUrl = '';
        let currentImageName = '';
        let currentCategory = '';
        let availableImages = {};
        let isLoading = false;
        let typingTimer;
        const doneTypingInterval = 30000;

        // API endpoint
        const API_BASE = 'https://ubiquitous-malasada.netlify.app/.netlify/functions';

        // Progress bar functions
        function showProgressBar(taskType) {
          progressContainer.classList.add('active');
          comparisonContainer.style.display = 'none';
          
          // Set expected time based on task type
          let totalTime;
          let label;
          
          if (taskType === 'maps' || taskType === 'flowchart') {
            totalTime = 60; // 1 minute for maps
            label = 'Generating map visualization...';
          } else if (taskType === 'table') {
            totalTime = 5; // 5 seconds for tables
            label = 'Generating ASCII table...';
          } else {
            totalTime = 20; // 20 seconds for charts
            label = 'Generating chart...';
          }
          
          progressLabel.textContent = label;
          progressTime.textContent = `Estimated time: ${totalTime}s`;
          
          // Animate progress bar
          let elapsed = 0;
          const interval = 100; // Update every 100ms
          
          const progressInterval = setInterval(() => {
            elapsed += interval;
            const percent = Math.min((elapsed / (totalTime * 1000)) * 100, 95);
            progressBarFill.style.width = percent + '%';
            progressPercent.textContent = Math.floor(percent) + '%';
            
            const remaining = Math.max(0, totalTime - Math.floor(elapsed / 1000));
            progressTime.textContent = `Time remaining: ~${remaining}s`;
            
            if (elapsed >= totalTime * 1000) {
              clearInterval(progressInterval);
              progressLabel.textContent = 'Finishing up...';
              progressBarFill.style.width = '95%';
            }
          }, interval);
          
          return progressInterval;
        }
        
        function hideProgressBar(progressInterval) {
          if (progressInterval) clearInterval(progressInterval);
          progressBarFill.style.width = '100%';
          progressPercent.textContent = '100%';
          progressLabel.textContent = 'Complete!';
          
          setTimeout(() => {
            progressContainer.classList.remove('active');
            progressBarFill.style.width = '0%';
            progressPercent.textContent = '0%';
          }, 500);
        }

        // Load available images when category changes
        categorySelect.addEventListener('change', async () => {
          const category = categorySelect.value;
          if (!category) {
            imageSelectorContainer.style.display = 'none';
            return;
          }

          currentCategory = category;
          imageSelect.innerHTML = '<option value="">-- Loading images from GitHub... --</option>';
          imageSelectorContainer.style.display = 'block';

          try {
            const owner = "Gleb-A-Lantsman";
            const repo = "IELTSTask1Checker";
            const visualsPath = `visuals/${category}`;
            const githubApiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${visualsPath}`;

            const response = await fetch(githubApiUrl);
            if (!response.ok) throw new Error(`GitHub fetch failed: ${response.status}`);
            const files = await response.json();

            // Filter only valid image files
            const imageFiles = files.filter(f => /\.(png|jpg|jpeg|webp)$/i.test(f.name));

            if (imageFiles.length === 0) {
              imageSelect.innerHTML = '<option value="">-- No images found in this category --</option>';
              return;
            }

            // Store them locally and build dropdown
            availableImages[category] = imageFiles;
            imageSelect.innerHTML = '<option value="">-- Choose an image --</option>';

            imageFiles.forEach((img, index) => {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = img.name;
              imageSelect.appendChild(option);
            });

            imageSelectorContainer.style.display = 'block';
          } catch (error) {
            console.error('Error fetching from GitHub:', error);
            imageSelect.innerHTML = '<option value="">-- Error loading images --</option>';
            showError('‚ö†Ô∏è Failed to fetch images from GitHub repository.');
          }
        });

        // Load selected image
        loadImageBtn.addEventListener('click', () => {
          const imageIndex = imageSelect.value;
          if (imageIndex === '' || !availableImages[currentCategory]) {
            return;
          }

          const image = availableImages[currentCategory][imageIndex];
          loadImage(image.download_url, image.name);
        });

        // Load random image
        randomImageBtn.addEventListener('click', () => {
          const category = categorySelect.value;
          if (!category) {
            alert('Please select a category first');
            return;
          }

          const images = availableImages[category];
          if (!images || images.length === 0) {
            alert('No images loaded for this category yet.');
            return;
          }

          const randomIndex = Math.floor(Math.random() * images.length);
          const image = images[randomIndex];
          imageSelect.value = randomIndex;
          loadImage(image.download_url, image.name);
        });

        // Load image and display
        async function loadImage(url, fileName) {
          currentImageUrl = url;
          currentImageName = fileName;
          
          taskImageContainer.innerHTML = `<img src="${url}" alt="Task 1 visual">`;
          imageInstructions.style.display = 'block';
          comparisonContainer.style.display = 'none';
          comparisonContainer.innerHTML = '';
          
          // Note: No Vision preload needed - SVG generated directly from student description
          visionStatusContainer.innerHTML = '<span class="vision-status vision-cached">‚úÖ Image loaded - SVG will be generated from your description</span>';
        }

        // Preload Vision analysis
        async function preloadVisionAnalysis() {
          visionStatusContainer.innerHTML = '<span class="vision-status vision-loading">üëÅÔ∏è Loading Vision analysis...</span>';

          try {
            const response = await fetch(`${API_BASE}/openai-proxy-task1`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                requestType: 'preload-vision',
                taskType: currentCategory,
                imageUrl: currentImageUrl,
                imageName: currentImageName
              })
            });

            // Check if response is OK before parsing
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // Get text first to avoid JSON parse errors
            const responseText = await response.text();
            if (!responseText || responseText.trim().length === 0) {
              throw new Error('Empty response from server');
            }

            let data;
            try {
              data = JSON.parse(responseText);
            } catch (parseError) {
              console.error('JSON parse error. Response:', responseText.substring(0, 500));
              throw new Error(`Failed to parse response: ${parseError.message}`);
            }

            if (data.error) {
              const errorMsg = data.message || 'Vision analysis failed';
              visionStatusContainer.innerHTML = `<span class="vision-status error-message">‚ö†Ô∏è ${errorMsg}</span>`;
              console.error('Vision error details:', data.details);
              return;
            }

            cachedVisionAnalysis = data.visionAnalysis;

            if (data.cached) {
              visionStatusContainer.innerHTML = '<span class="vision-status vision-cached">‚úÖ Vision analysis loaded from cache</span>';
            } else {
              // NEW: Auto-download the Vision analysis
              if (data.shouldDownload && data.downloadFilename) {
                downloadVisionAnalysis(data.visionAnalysis, data.downloadFilename);
                visionStatusContainer.innerHTML = `<span class="vision-status vision-downloaded">‚úÖ Vision analysis downloaded: ${data.downloadFilename}</span>`;
                
                // Show GitHub path if available
                if (data.githubPath) {
                  const pathNote = document.createElement('div');
                  pathNote.style.cssText = 'margin-top: 5px; font-size: 12px; color: #666;';
                  pathNote.textContent = `üìÇ Upload to: ${data.githubPath}`;
                  visionStatusContainer.appendChild(pathNote);
                }
              } else {
                visionStatusContainer.innerHTML = '<span class="vision-status vision-cached">‚úÖ Vision analysis loaded (new)</span>';
              }
            }

          } catch (error) {
            console.error('Vision preload error:', error);
            visionStatusContainer.innerHTML = `<span class="vision-status error-message">‚ö†Ô∏è Vision failed: ${error.message}</span>`;
          }
        }

        // NEW: Auto-download function
        function downloadVisionAnalysis(content, filename) {
          const blob = new Blob([content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          console.log('üì• Vision analysis downloaded:', filename);
        }

        function showError(message) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          errorDiv.textContent = message;
          taskImageContainer.appendChild(errorDiv);
          setTimeout(() => errorDiv.remove(), 5000);
        }

        // Word count
        function updateWordCount() {
          const text = essayTextarea.value.trim();
          const count = text ? text.split(/\s+/).length : 0;
          wordCountDisplay.textContent = `${count} words`;
          
          if (count < 150) {
            wordGoalDisplay.textContent = `Need ${150 - count} more words to reach minimum`;
            wordGoalDisplay.style.color = '#ff9800';
          } else {
            wordGoalDisplay.textContent = '‚úì Word count requirement met';
            wordGoalDisplay.style.color = '#4caf50';
          }
        }

        essayTextarea.addEventListener('input', () => {
          updateWordCount();
          clearTimeout(typingTimer);
          typingTimer = setTimeout(() => {
            if (essayTextarea.value.length > 50) {
              requestFeedback('help');
            }
          }, doneTypingInterval);
        });

        // Help button
        helpButton.addEventListener('click', () => {
          if (essayTextarea.value.length > 10) {
            requestFeedback('help');
          } else {
            feedbackContainer.innerHTML = '<h4>Writing Help</h4><p>Please write something first.</p>';
          }
        });

        // Feedback button
        feedbackButton.addEventListener('click', () => {
          if (!currentImageUrl) {
            feedbackContainer.innerHTML = '<h4>Writing Feedback</h4><p>Please load a task image first.</p>';
            return;
          }
          
          if (essayTextarea.value.length > 10) {
            requestFeedback('full-feedback');
          } else {
            feedbackContainer.innerHTML = '<h4>Writing Feedback</h4><p>Please write something first.</p>';
          }
        });

       async function requestFeedback(type) {
  if (isLoading) return;
  isLoading = true;

  const content = essayTextarea.value;

  if (currentCategory === "maps" && type === "full-feedback") {
    console.log("üó∫Ô∏è Using Batch Jobs for MAPS");

    // -----------------------------------------------------
    // 1) Submit job
    // -----------------------------------------------------
    let submitRes = await fetch(`${API_BASE}/openai-proxy-task1`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        phase: "submit",
        requestType: type,
        taskType: currentCategory,
        content
      })
    });

    let submitData = await submitRes.json();
    let job_id = submitData.job_id;

    console.log("‚úÖ Job submitted:", job_id);

    // Show placeholder feedback immediately
    feedbackContainer.innerHTML = `
      <h4>Complete Feedback</h4>
      <p>Generating map visualization‚Ä¶</p>
    `;

    let svg = null;

    // -----------------------------------------------------
    // 2) Poll every 2 seconds
    // -----------------------------------------------------
    while (!svg) {
      await new Promise(r => setTimeout(r, 2000));

      let pollRes = await fetch(`${API_BASE}/openai-proxy-task1`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phase: "poll",
          requestType: type,
          taskType: currentCategory,
          job_id
        })
      });

      let pollData = await pollRes.json();

      if (pollData.status === "completed") {
        svg = pollData.generatedSvg;
      } else {
        console.log("‚è≥ Waiting‚Ä¶", pollData.status);
      }
    }

    console.log("‚úÖ SVG received");

    // Feedback
    const fbRes = await fetch(`${API_BASE}/openai-proxy-task1`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        requestType: "help", // already computed earlier in pipeline
        content
      })
    });

    const fbData = await fbRes.json();
    feedbackContainer.innerHTML = formatFullFeedback(fbData.feedback);

    // -----------------------------------------------------
    // Display comparison
    // -----------------------------------------------------
    comparisonContainer.style.display = "block";
    comparisonContainer.innerHTML = `
      <div class="comparison-container">
        <div class="comparison-side">
          <h5>Original Task Image</h5>
          <img src="${currentImageUrl}">
        </div>

        <div class="comparison-side">
          <h5>Your Description ‚Üí SVG</h5>
          <div style="
              background:white;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #ccc;
              overflow:auto;
            ">
            ${svg}
          </div>
        </div>
      </div>
    `;

    isLoading = false;
    return;
  }

// -----------------------------------------------------
  // ‚úÖ NON-MAPS ‚Üí fall back to original full-feedback logic
  // -----------------------------------------------------
  if (type === 'full-feedback') {
    // Use progress bar for non-map types
    let progressInterval = showProgressBar(currentCategory);

    try {
      const res = await fetch(`${API_BASE}/openai-proxy-task1`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          content,
          requestType: type,
          taskType: currentCategory,
          imageUrl: currentImageUrl,
          imageName: currentImageName
        })
      });

      const data = await res.json();

      hideProgressBar(progressInterval);

      if (data.error) {
        feedbackContainer.innerHTML = `<h4>Complete Feedback</h4><p class="error-message">${data.message || 'Error generating feedback'}</p>`;
        return;
      }

      displayFullFeedback(data);
      isLoading = false;
      return;

    } catch (err) {
      hideProgressBar(progressInterval);
      feedbackContainer.innerHTML = `<h4>Complete Feedback</h4><p class="error-message">An error occurred. Please try again.</p>`;
      isLoading = false;
      return;
    }
  }

  // -----------------------------------------------------
  // ‚úÖ HELP REQUEST stays the same
  // -----------------------------------------------------
  if (type === 'help') {
    const res = await fetch(`${API_BASE}/openai-proxy-task1`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        content,
        requestType: type,
        taskType: currentCategory
      })
    });

    const data = await res.json();
    feedbackContainer.innerHTML = formatHelpFeedback(data.feedback);
    isLoading = false;
    return;
  }
}


        function displayFullFeedback(data) {
          // Display text feedback
          feedbackContainer.innerHTML = formatFullFeedback(data.feedback);

          // Reset comparison area
          comparisonContainer.innerHTML = "";
          comparisonContainer.style.display = "block";

          // Case 1: ASCII table
          if (data.asciiTable) {
            comparisonContainer.innerHTML = `
              <div class="comparison-container">
                <div class="comparison-side">
                  <h5>üìä Original Task Image</h5>
                  <img src="${currentImageUrl}" alt="Original task image">
                </div>
                <div class="comparison-side">
                  <h5>üßÆ AI ASCII Table from Your Description</h5>
                  <pre style="background:#fafafa; padding:15px; border-radius:4px; border:1px solid #ddd; font-family:monospace; overflow-x:auto;">
${data.asciiTable}
                  </pre>
                </div>
              </div>
            `;
            return;
          }

          // Case 2: SVG visualization
          if (data.generatedSvg) {
            comparisonContainer.innerHTML = `
              <div class="comparison-container">
                <div class="comparison-side">
                  <h5>üó∫Ô∏è Original Task Image</h5>
                  <img src="${currentImageUrl}" alt="Original task image" style="max-width: 100%; height: auto; border-radius: 4px;">
                </div>
                <div class="comparison-side">
                  <h5>üé® SVG Visualization of Your Description</h5>
                  <div style="
                    background: white; 
                    padding: 15px; 
                    border-radius: 4px; 
                    border: 2px solid #ddd; 
                    overflow: auto;
                    min-height: 400px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                  ">
                    ${data.generatedSvg}
                  </div>
                  <p style="margin-top: 10px; font-size: 13px; color: #666; text-align: center;">
                    Vector illustration generated from your description using SVG.
                  </p>
                </div>
              </div>
            `;
            return;
          }

          // Case 3: Matplotlib chart
          if (data.generatedImageBase64) {
            comparisonContainer.innerHTML = `
              <div class="comparison-container">
                <div class="comparison-side">
                  <h5>üìä Original Task Image</h5>
                  <img src="${currentImageUrl}" alt="Original task image" style="max-width: 100%; height: auto;">
                </div>
                <div class="comparison-side">
                  <h5>üêç Python Visualization of Your Description</h5>
                  <img src="${data.generatedImageBase64}" alt="Generated Python chart" style="max-width: 100%; height: auto; border-radius: 4px;">
                  <p style="margin-top: 10px; font-size: 13px; color: #666; text-align: center;">
                    Chart generated using Python (Matplotlib + Pandas) based on your description.
                  </p>
                </div>
              </div>
            `;
            return;
          }
        }

        function formatFullFeedback(fb) {
          const text = fb.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          let html = '<h4>Complete Feedback</h4>';

          // Parse sections for Task 1 criteria
          const sections = {
            'Task Achievement': 'task-achievement',
            'Coherence and Cohesion': 'coherence-cohesion',
            'Lexical Resource': 'lexical-resource',
            'Grammatical Range and Accuracy': 'grammatical-range'
          };

          Object.keys(sections).forEach(sectionName => {
            const regex = new RegExp(`<strong>${sectionName}:?</strong>([\\s\\S]*?)(?=<strong>|$)`, 'i');
            const match = text.match(regex);
            
            if (match) {
              const content = match[1].trim();
              html += `
                <div class="criteria-section ${sections[sectionName]}">
                  <h5>${sectionName}</h5>
                  <p>${content}</p>
                </div>
              `;
            }
          });

          // If no structured sections found, display as-is
          if (!text.match(/Task Achievement|Coherence and Cohesion|Lexical Resource|Grammatical Range/i)) {
            html += `<p>${text}</p>`;
          }

          return html;
        }

        function formatHelpFeedback(fb) {
          const clean = fb.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').trim();
          
          const classes = {
            'Missing content:': 'missing-content',
            'Structure issue:': 'structure-issue',
            'Word choice:': 'word-choice',
            'Grammar check:': 'grammar-check',
            'Good progress!': 'good-progress',
            'Data accuracy:': 'data-accuracy'
          };

          let html = '<h4>Writing Help</h4>';
          let matched = false;

          Object.keys(classes).forEach(label => {
            const tag = `<strong>${label}</strong>`;
            if (!matched && clean.includes(tag)) {
              const content = clean.split(tag)[1].trim();
              html += `<div class="help-feedback ${classes[label]}"><strong>${label}</strong> ${content}</div>`;
              matched = true;
            }
          });

          if (!matched) {
            html += `<p>${clean}</p>`;
          }

          return html;
        }

        // Initialize
        updateWordCount();
      });
    </script>
  </body>
</html>
